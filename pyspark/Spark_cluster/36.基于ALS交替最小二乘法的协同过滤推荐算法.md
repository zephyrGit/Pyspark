
- 协同过滤是基于一组兴趣相同的用户或项目进行的推荐，他根据邻居用户（与目标用户相似的用户）的偏好信息产生对目标用户的推荐列表。关于协同过滤的一个经典的例子就是看电影。如果你不知道哪一部电影是自己喜欢或者评分比较高的，那么通常的做法就是问问周围的朋友，而在问的时候，肯定都习惯于问跟自己口味差不多的朋友，这就是协同过滤的核心思想。因此，协同过滤是在海量数据中挖掘出小部分与你品味类似的用户，在协同过滤中，这些用户成为邻居，然后根据他们喜欢的东西组成一个排序的目录推荐你  

- 协同过滤算法主要分为基于用户的协同过滤算法和基于项目的协同过滤算法。MLlib当前支持基于模型的协同过滤，其中用户和商品通过一小组隐语因子进行表达，并且这些因子也用于预测缺失的元素。Spark MLlib实现了交替最小二乘法（ALS）来学习这些隐语因子  

- 推荐一句中有显性和隐性的因素，显性反馈行动为包括用户明确表示物品喜好的行为，隐性反馈行为指的是那些不能明确反应用户喜好的行为。在许多的现实生活中的很多场景中，我们通常只能接触到隐性的反馈。例如页面浏览、点击、购买、喜欢、分享等等。接下来使用Movielens电影数据集，来实现写协同过滤算法  

- **算法原理**  
    ALS是交替最小二乘的简称，在机器学习上下文中，ALS指定使用交替最小二乘求解的一个协同过滤推荐算法。它通过观察到所有的用户给物品的打分，来推断每个用户的喜好并向用户推荐合适的物品  
    核心假设：打分矩阵是近似低秩的，也就是说一个mn阶的打分矩阵Rmn可以用两个小矩阵Xkm和Ykn的乘积来近似
    $$R_{(mxn)} \approx X^T_{(kxm)}Y_{(kxn)}$$
    其中 k << min(m, n)  
    假设的合理性：描述一个人的喜好通常是在一个抽象的低维空间进行的，并不需要一一列出其具体喜好的事物，比如说一个人喜欢悬疑类电影，民谣歌曲...  
    为了找到使得矩阵X和Y的乘积尽可能地逼近R，采用最小化平方误差损失函数：  
    $$L(X,Y)=\Sigma(r_{(ui)}-x^T_uy_i)^2$$
    其中，rui表示第u个用户对第i个物品地评分，xu(k1阶)表示用户u地偏好隐含特征向量1<=u<=m,yi（k1阶）表示商品i的隐含特征向量1<=i<=n，用于u对物品i的评分近似为：  
    $$X^T_u y_i$$
    为防止过拟合，加入正则化项：  
    $$L(X,Y) = \Sigma(r_{(ui)}- x^T_u y_i)^2 + \lambda(|x_u|^2 + |y_i|^2)$$
    至此，协同过滤问题转化为一个优化问题，但是由于xu 和 yi耦合在一起，比不好求解。故此引用ALS：先确定Y，由上式求解X，然后再固定求得X，求解Y，如此交替执行直到误差满足阈值条件或者到达迭代次数上限  

- 使用ALS算法实现协同过滤推荐    
1. 首先查看movielens数据   
0::2::3::1424380312  
0::3::1::1424380312  
0::5::2::1424380312  
...  
第一列数字是用户ID，第二个数字是电影ID,第三个数字是用户对这部电影的评分，最后一个数字是时间戳。每个数字使用‘::’分隔  

~~~python

from pyspark.sql import SparkSession
from pyspark.ml.evaluation import RegressionEvaluator
from pyspark.sql import Row
from pyspark.ml.recommendation import ALS

spark = SparkSession.builder.master('local').appName('ALS').getOrCreate()
sc = spark.sparkContext

# 加载数据
rdd = sc.textFile('/data/mllib/als/sample_movielens_ratings.txt')
# 切分数据  -- 原始数据以’::‘分割，现在需要把字符串切分出来
rdd1 = rdd.map(lambda x: x.split('::'))

# .把每行数据中的每个字段，用来构造Row对象，这样就可以使用Row对象来创建pyspark中的DataFrame。注意用户id，电影的id,都支持int类型，评分项支持float类型，时间戳支持str类型
rdd2 = rdd1.map(lambda x: Row(userId=int(x[0]),
                              movieId=int(x[1]),
                              rating=float(x[2]),
                              timestamp=str(x[3])))

# 使用rdd创建DataFrame
df = spark.createDataFrame(rdd2)

# 划分训练集和测试集
train, test = df.randomSplit([0.8, 0.2])

# 使用ALS构建推荐模型
als = ALS(maxIter=5,
          regParam=0.01,
          userCol='userId',
          itemCol='movieId',
          ratingCol='rating',
          coldStartStrategy='drop')

model = als.fit(train)
~~~

参考解释：  
ALS默认的参数值如下：   
ALS(rank=10, maxIter=10, regParam=0.1, numUserBlocks=10, implicitPrefs=False, alpha=1.0, userCol='userId')  
- numUserBlocks和numItemBlocks是分别用于并行化计算的用户和商品的分块个数（默认为10）
- rank是模型中隐语因子的个数（默认为10）
- maxIter是迭代的次数（默认为10）
- regParam是ALS的正则化参数（默认为0.1）
- implicitPrefs决定了是用显性反馈ALS的版本还是用适用隐形反馈数据集的版本（默认False，即用显性反馈）
- alpha是一个针对于隐性反馈ALS版本的参数，这个参数决定了偏好行为强度的基准（默认为1.0）
- nonnegative决定是否对最小二乘法适用非负的限制（默认为false）
- coldStartStrategy 冷启动策略，可选参数为nan和drop
----
需要对冷启动策略做一个说明，什么是冷启动？对于一个没有任何历史信息的用户，怎么去为他推荐产品，或者对于一个没有任何评价的新产品，怎么去推给用户，再没有热数据的情况下，进行的推荐，进行的模型的训练就称为冷启动。除了没有历史数据，还有一种情况就是我们在训练模型的时候通常会采用crossvalidation交叉验证。对于训练集和验证集数据是随机划分的，何有可能在划分到训练集中的数据恰好没有包括某个用户，而在验证集中又出现了这个用户，这是相当于是在没有任何用户数据的情况下，为用户推荐产品，也是属于冷启动范畴  

spark系统过滤推荐算法对于冷启动提供了两个可选的策略，nan和drop。nan策略在无法推荐的时候，填充nan；而drop策略则是直接删除掉不能推荐的数据  

~~~python
# 测试和验证模型  
predictions = model.transform(test)
evaluator = RegressionEvaluator(metricName='rmse',
                                labelCol='rating',
                                predictionCol='prediction')
rmse = evaluator.evaluate(predictions)
print('Root-Mean-Squared-Error = ' + str(rmse))
>>>  Root-Mean-Squared-Error = 1.5897427210915602 
~~~
均方根误差为：1.5897427210915602，这个地方实际可以采用gridsearch网格搜索算法，去找出使得均方误差最小的超参数  

- 推荐
模型训练好之后，接下来就可以为每个用户推荐指定数量的电影；也可以为每部电影推荐指定数量的用户了  

~~~python

# 为每个用户推荐10部电影 
userRecs = model.recommendForAllUsers(10)
userRecs.show(truncate=False)
>>>  
+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|userId|recommendations                                                                                                                                                         |
+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|28    |[[92, 5.1042356], [12, 4.758648], [40, 4.5487976], [49, 4.1722937], [2, 4.1566596], [89, 3.999705], [70, 3.888116], [10, 3.8768468], [82, 3.680962], [20, 3.2542324]]   |
|26    |[[90, 6.973097], [51, 5.8037148], [8, 5.6555185], [32, 5.467811], [22, 5.2476115], [24, 5.0799627], [94, 5.060182], [88, 4.9447675], [7, 4.8465266], [23, 4.769021]]    |
|27    |[[32, 4.13043], [79, 4.052179], [18, 3.9497764], [19, 3.1583755], [83, 3.0505762], [66, 3.0494773], [55, 3.04762], [80, 3.0407684], [27, 2.853963], [54, 2.8340766]]    |
|12    |[[90, 5.802627], [64, 4.899808], [27, 4.8430943], [28, 4.61794], [46, 4.3249416], [35, 4.2616367], [94, 4.1965256], [31, 4.003344], [50, 3.8293571], [55, 3.7331722]]   |
|22    |[[51, 5.1426907], [22, 4.994391], [75, 4.990205], [30, 4.6465216], [88, 4.599775], [32, 4.149783], [98, 4.0927105], [68, 4.061587], [69, 4.0246816], [62, 3.490123]]    |
|1     |[[68, 3.7543802], [98, 3.562766], [22, 3.4201233], [75, 3.277558], [77, 3.225964], [32, 2.8651295], [28, 2.8620899], [51, 2.814551], [80, 2.6621304], [9, 2.6463873]]   |
|13    |[[93, 3.9872932], [76, 3.2004154], [53, 3.14758], [37, 3.1341062], [2, 3.117028], [74, 3.0457969], [39, 2.9820864], [18, 2.9015484], [41, 2.8672693], [83, 2.8545005]]  |
|6     |[[25, 5.0598264], [43, 3.8791282], [58, 3.7545195], [85, 3.0121875], [55, 2.942031], [61, 2.9371047], [17, 2.9294016], [67, 2.9242084], [31, 2.4900885], [46, 2.062307]]|
|16    |[[62, 5.540086], [85, 5.015884], [90, 5.003984], [76, 4.8433423], [51, 4.4562235], [22, 4.3539443], [69, 3.6672587], [29, 3.428669], [47, 3.26766], [94, 3.2291303]]    |
|3     |[[51, 4.9989047], [90, 4.716485], [88, 4.336691], [22, 4.1329722], [80, 4.043616], [18, 3.7264495], [32, 3.69221], [98, 3.3511102], [94, 3.156012], [7, 3.1109896]]     |
|20    |[[38, 5.6459827], [22, 4.482069], [75, 4.3114314], [76, 4.1336584], [30, 3.716928], [77, 3.6914983], [68, 3.6479988], [80, 3.4432497], [28, 3.3506253], [11, 3.2913382]]|
|5     |[[32, 4.084897], [90, 3.7075868], [49, 3.692083], [23, 3.5163717], [46, 3.4799976], [55, 3.3284175], [24, 3.267574], [94, 3.2153609], [9, 3.07942], [64, 3.0712314]]    |
|19    |[[22, 3.9874792], [88, 3.8061545], [90, 3.7842722], [32, 3.6942394], [51, 3.6440732], [98, 3.535872], [68, 3.49134], [75, 3.4729395], [30, 3.1297953], [94, 2.7964413]] |
|15    |[[46, 4.852397], [92, 4.0915914], [9, 4.0637584], [68, 3.9085636], [1, 3.7150857], [98, 2.9828973], [26, 2.9384768], [77, 2.930187], [64, 2.8562932], [90, 2.7579129]]  |
|17    |[[46, 5.081911], [20, 4.9490604], [17, 4.900722], [55, 4.86418], [90, 4.828725], [94, 3.9997234], [10, 3.9617229], [22, 3.6903095], [27, 3.5488105], [31, 3.4516425]]   |
|9     |[[65, 6.0210996], [7, 4.9061317], [49, 4.8998137], [23, 3.9186957], [41, 3.8810933], [32, 3.872162], [76, 3.8696196], [18, 3.7850642], [87, 3.7761006], [28, 3.746434]] |
|4     |[[74, 3.8644667], [52, 3.83966], [2, 3.7501254], [41, 3.710028], [70, 3.6375947], [92, 3.6169014], [29, 3.4937878], [18, 3.2763383], [93, 3.160892], [58, 3.0790107]]   |
|8     |[[47, 5.0558224], [29, 5.0473843], [52, 5.006679], [85, 4.693166], [58, 4.0986323], [62, 4.0498457], [39, 3.8047743], [43, 3.7552438], [2, 3.7314034], [41, 3.5599127]] |
|23    |[[48, 5.177554], [32, 5.102498], [62, 4.933902], [49, 4.9033613], [65, 4.721325], [55, 4.601031], [25, 4.4846096], [30, 4.102382], [50, 4.0299425], [13, 4.023654]]     |
|7     |[[25, 4.7040706], [85, 4.3589816], [62, 4.082585], [43, 4.0165963], [47, 3.942559], [29, 3.7178736], [41, 3.207932], [28, 3.2034461], [39, 3.093678], [87, 2.9644115]]  |
+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
only showing top 20 rows


# 为每部电影推荐10个用户
movieRecs = model.recommendForAllItems(10)
movieRecs.show(truncate=False)
>>>  
+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|movieId|recommendations                                                                                                                                                          |
+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|31     |[[12, 4.003344], [17, 3.4516425], [8, 2.853728], [6, 2.4900885], [21, 2.3605452], [26, 2.3440943], [14, 1.9547405], [16, 1.8146105], [25, 1.5393329], [15, 1.5387665]]   |
|85     |[[16, 5.015884], [8, 4.693166], [7, 4.3589816], [22, 3.3129678], [6, 3.0121875], [21, 2.6506116], [1, 2.6232305], [20, 2.450343], [14, 2.2338035], [10, 1.8246728]]      |
|65     |[[9, 6.0210996], [11, 4.7356734], [23, 4.721325], [12, 3.2666924], [26, 2.874238], [0, 2.4751952], [29, 2.369331], [5, 2.2646399], [7, 2.2418697], [1, 2.159649]]        |
|53     |[[21, 4.6895914], [24, 3.3447697], [14, 3.2602136], [22, 3.2162652], [13, 3.14758], [20, 3.0119486], [4, 2.9856668], [2, 2.7083466], [3, 2.6862564], [10, 2.4231522]]    |
|78     |[[21, 1.1921271], [4, 1.1513039], [23, 1.1336954], [12, 1.1037328], [22, 1.0931263], [2, 1.0785394], [11, 1.014297], [15, 1.0034335], [20, 0.9980855], [19, 0.9880093]]  |
|34     |[[25, 3.0687685], [26, 2.7481308], [3, 2.7387319], [21, 1.9068272], [0, 1.2640119], [19, 1.1750059], [16, 1.1729357], [1, 0.9827514], [14, 0.97421694], [15, 0.93268025]]|
|81     |[[11, 3.9422903], [23, 3.0588362], [26, 2.9143832], [29, 2.8434808], [17, 2.7666736], [27, 2.7197418], [12, 2.579976], [9, 2.1566832], [2, 2.0311577], [5, 1.9463594]]   |
|28     |[[18, 4.9713507], [12, 4.61794], [9, 3.746434], [20, 3.3506253], [7, 3.2034461], [1, 2.8620899], [26, 2.5850217], [15, 2.2974935], [3, 2.0945122], [13, 1.9930186]]      |
|76     |[[21, 5.416571], [14, 4.9932766], [16, 4.8433423], [20, 4.1336584], [9, 3.8696196], [13, 3.2004154], [18, 3.0485744], [7, 2.9578211], [24, 2.795494], [3, 2.6846015]]    |
|26     |[[15, 2.9384768], [0, 2.8731744], [4, 2.30951], [1, 2.164139], [12, 1.7216035], [28, 1.6971309], [21, 1.5133582], [19, 1.4219323], [13, 1.4117703], [25, 1.180237]]      |
|27     |[[11, 5.095963], [12, 4.8430943], [18, 3.626238], [17, 3.5488105], [24, 3.1106102], [27, 2.853963], [29, 2.3378704], [23, 2.1015248], [2, 1.7445223], [20, 1.5628209]]   |
|44     |[[11, 3.4733217], [24, 2.7830174], [27, 2.7504601], [12, 2.2370722], [17, 2.1517112], [23, 2.082261], [29, 1.9541243], [19, 1.8227906], [26, 1.8002994], [22, 1.58356]]  |
|12     |[[28, 4.758648], [2, 2.9739985], [5, 2.9442916], [12, 2.6351142], [15, 2.6212556], [25, 2.5380054], [17, 2.045334], [18, 2.0428534], [0, 1.8350978], [29, 1.7692916]]    |
|91     |[[14, 3.4026337], [21, 3.0957537], [12, 3.0713224], [25, 3.0641458], [0, 2.8877199], [24, 2.6558938], [8, 2.5320835], [4, 2.3998265], [15, 2.2217562], [23, 2.1869066]]  |
|22     |[[26, 5.2476115], [22, 4.994391], [20, 4.482069], [16, 4.3539443], [3, 4.1329722], [19, 3.9874792], [17, 3.6903095], [1, 3.4201233], [5, 3.0590792], [29, 3.004334]]     |
|93     |[[2, 5.1793427], [18, 4.41574], [21, 4.1971965], [13, 3.9872932], [20, 3.2773306], [4, 3.160892], [28, 2.8006597], [8, 2.633216], [14, 2.1937623], [3, 2.0451694]]       |
|47     |[[8, 5.0558224], [7, 3.942559], [25, 3.8436022], [16, 3.26766], [14, 3.2645316], [9, 3.206748], [23, 2.6140294], [21, 2.5792828], [10, 2.2958872], [28, 1.9458258]]      |
|1      |[[15, 3.7150857], [0, 3.5672464], [12, 3.067074], [8, 2.8267646], [25, 2.7432451], [4, 2.5697525], [1, 2.521324], [21, 2.4445157], [13, 1.4032667], [5, 1.3967187]]      |
|52     |[[25, 6.470825], [21, 5.578599], [8, 5.006679], [14, 4.7195435], [4, 3.83966], [26, 3.117178], [0, 3.059588], [16, 3.025978], [3, 2.9250662], [22, 2.7539577]]           |
|13     |[[23, 4.023654], [11, 3.9476187], [29, 3.1771092], [26, 2.9602787], [5, 2.9152231], [9, 2.7706544], [12, 2.5547073], [28, 2.1980135], [17, 2.0438788], [10, 1.9662578]]  |
+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
only showing top 20 rows
~~~

- 为指定用户推荐10部电影  

用户id为  

~~~python

users = [Row(userId=26), Row(userId=29),Row(userId=19)]
users_data_set = spark.createDataFrame(users)
userSubsetRecs = model.recommendForUserSubset(users_data_set, 10)
userSubsetRecs.show(truncate=False)
>>> 
+------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------+|userId|recommendations|+------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|26    |[[90, 6.973097], [51, 5.8037148], [8, 5.6555185], [32, 5.467811], [22, 5.2476115], [24, 5.0799627], [94, 5.060182], [88, 4.9447675], [7, 4.8465266], [23, 4.769021]]   |
|19    |[[22, 3.9874792], [88, 3.8061545], [90, 3.7842722], [32, 3.6942394], [51, 3.6440732], [98, 3.535872], [68, 3.49134], [75, 3.4729395], [30, 3.1297953], [94, 2.7964413]]|
|29    |[[90, 4.0706115], [32, 3.762766], [23, 3.6878834], [55, 3.6641161], [48, 3.2689734], [94, 3.2384372], [62, 3.183099], [13, 3.1771092], [49, 3.0858603], [22, 3.004334]]|
+------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------+

~~~

- 为指定的电影推荐10个用户  

~~~python

movies = [Row(movieId=26), Row(movieId=29), Row(movieId=65)]
movie_data_set = spark.createDataFrame(movies)
movieSubSetRecs = model.recommendForItemSubset(movie_data_set, 10)
movieSubSetRecs.show(truncate=False)
>>>   
+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|movieId|recommendations                                                                                                                                                    |
+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|65     |[[9, 6.0210996], [11, 4.7356734], [23, 4.721325], [12, 3.2666924], [26, 2.874238], [0, 2.4751952], [29, 2.369331], [5, 2.2646399], [7, 2.2418697], [1, 2.159649]]  |
|26     |[[15, 2.9384768], [0, 2.8731744], [4, 2.30951], [1, 2.164139], [12, 1.7216035], [28, 1.6971309], [21, 1.5133582], [19, 1.4219323], [13, 1.4117703], [25, 1.180237]]|
|29     |[[8, 5.0473843], [21, 4.512435], [7, 3.7178736], [4, 3.4937878], [16, 3.428669], [22, 3.314804], [2, 3.2443209], [26, 3.1681612], [3, 3.1020095], [13, 2.789721]]  |
+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------+

~~~

- 保存和加载训练好的模型  

~~~python

from pyspark.ml.recommendation import ALSModel
model.write().overwrite().save('/data/als/')
model1 = ALSModel.load('/data/als/') 
model.rank
>>>  10

model1.rank
>>>  10
~~~
